<% if section != :completed %>
  <li id="<%= dom_id(todo) %>" data-id="<%= todo.id %>" data-todo-id="<%= todo.id %>" class="relative flex flex-col gap-4 rounded-2xl border border-slate-200/70 bg-white px-4 py-4 shadow-sm sm:flex-row sm:items-center sm:justify-between">
    <div class="flex items-center gap-3 pr-12 sm:min-w-0 sm:pr-0">
      <button type="button"
              role="checkbox"
              aria-checked="false"
              aria-label="Mark todo done"
              data-controller="todo-checkbox"
              data-action="click->todo-checkbox#toggle"
              data-todo-checkbox-url-value="<%= complete_todo_path(todo) %>"
              data-todo-checkbox-delay-value="400"
              class="todo-checkbox flex h-8 w-8 shrink-0 items-center justify-center rounded-full border border-slate-300 bg-white text-transparent transition focus:outline-none focus:ring-2 focus:ring-blue-400">
        <svg class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
          <path fill-rule="evenodd" d="M16.704 5.29a1 1 0 0 1 0 1.414l-7.25 7.25a1 1 0 0 1-1.414 0l-3.25-3.25a1 1 0 1 1 1.414-1.414l2.543 2.543 6.543-6.543a1 1 0 0 1 1.414 0Z" clip-rule="evenodd" />
        </svg>
      </button>
      <div class="min-w-0">
        <p class="text-base font-medium text-slate-900"><%= todo.title %></p>
        <% if todo.milestone && local_assigns.fetch(:show_milestone_label, true) %>
          <%= link_to project_milestone_path(todo.milestone.project, todo.milestone),
                class: "inline-flex items-center gap-1 mt-1 text-xs text-blue-600 hover:text-blue-800 transition" do %>
            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
            </svg>
            <%= todo.milestone.name %> for <%= todo.milestone.project.name %>
          <% end %>
        <% end %>
      </div>
    </div>
    <div class="flex w-full flex-col gap-2 pr-12 sm:w-auto sm:flex-row sm:items-center sm:gap-3 sm:justify-end sm:pr-12">
      <div class="flex flex-1 flex-wrap gap-2 sm:order-first sm:flex-none sm:justify-end">
        <%# Move to... dropdown %>
        <div class="relative inline-block" data-controller="dropdown">
          <button type="button"
                  data-action="click->dropdown#toggle"
                  class="rounded-full border border-slate-300 bg-white px-4 py-2 text-xs font-semibold uppercase tracking-wide text-slate-600 hover:bg-slate-50 transition">
            Move to...
          </button>

          <div data-dropdown-target="menu"
               class="hidden absolute right-0 mt-2 w-40 rounded-lg border bg-white shadow-lg z-10">
            <% Todo.priority_windows.keys.reject { |w| w == section.to_s }.each do |window| %>
              <%= button_to window.titleize,
                            move_todo_path(todo, priority_window: window),
                            method: :patch,
                            class: "block w-full text-left px-4 py-2 text-sm text-slate-700 hover:bg-slate-50 transition",
                            form: { class: "w-full" } %>
            <% end %>
          </div>
        </div>

        <%= button_to(
              "Delete",
              todo_path(todo),
              method: :delete,
              form: { data: { turbo_confirm: "Delete this todo?" }, class: "inline-block" },
              class: "rounded-full border border-red-500/40 bg-red-50 px-4 py-2 text-xs font-semibold uppercase tracking-wide text-red-600 transition hover:bg-red-100"
            ) %>
      </div>
    </div>

    <span class="todo-drag-handle absolute right-4 top-4 flex h-8 w-8 items-center justify-center rounded-full border border-slate-200 bg-white/80 text-slate-400 shadow-sm transition hover:text-slate-600 sm:right-4 sm:top-4" aria-label="Drag to reorder">
      <svg class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
        <circle cx="7" cy="6" r=".9" />
        <circle cx="13" cy="6" r=".9" />
        <circle cx="7" cy="10" r=".9" />
        <circle cx="13" cy="10" r=".9" />
        <circle cx="7" cy="14" r=".9" />
        <circle cx="13" cy="14" r=".9" />
      </svg>
    </span>
  </li>
<% else %>
  <li id="<%= dom_id(todo) %>" data-id="<%= todo.id %>" class="flex flex-col gap-3 rounded-2xl border border-slate-200/60 bg-white px-4 py-3 text-sm text-slate-600 sm:flex-row sm:items-center sm:justify-between">
    <div class="sm:min-w-0">
      <p class="font-medium text-slate-800"><%= todo.title %></p>
      <% if todo.milestone && local_assigns.fetch(:show_milestone_label, true) %>
        <%= link_to project_milestone_path(todo.milestone.project, todo.milestone),
              class: "inline-flex items-center gap-1 text-xs text-blue-600 hover:text-blue-800 transition" do %>
          <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
          </svg>
          <%= todo.milestone.name %> for <%= todo.milestone.project.name %>
        <% end %>
      <% end %>
      <p class="text-slate-500"><%= local_time(todo.completed_at, format: :weekdayWithTime) %></p>
    </div>
    <div class="flex flex-wrap gap-2 sm:justify-end">
      <%= button_to(
            "Mark undone",
            complete_todo_path(todo),
            method: :patch,
            class: "rounded-full border border-blue-500/50 bg-blue-50 px-3 py-2 text-xs font-semibold uppercase tracking-wide text-blue-700 transition hover:bg-blue-100",
            form: { class: "inline-block" }
          ) %>
      <%= button_to(
            "Delete",
            todo_path(todo),
            method: :delete,
            form: { data: { turbo_confirm: "Delete this todo?" }, class: "inline-block" },
            class: "rounded-full border border-red-500/40 bg-red-50 px-3 py-2 text-xs font-semibold uppercase tracking-wide text-red-600 transition hover:bg-red-100"
          ) %>
    </div>
  </li>
<% end %>
